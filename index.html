<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Player</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #0f0f0f;
            color: white;
        }
        
        .player-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #000;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .controls-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .video-container:hover .controls-overlay {
            opacity: 1;
        }
        
        .control-group {
            display: flex;
            align-items: center;
        }
        
        .control-button {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            margin: 0 5px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .control-button:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .quality-menu {
            position: absolute;
            bottom: 50px;
            right: 10px;
            background: rgba(28, 28, 28, 0.9);
            border-radius: 4px;
            padding: 8px 0;
            display: none;
            flex-direction: column;
            min-width: 100px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 20;
        }
        
        .quality-menu.visible {
            display: flex;
        }
        
        .quality-option {
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .quality-option:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .quality-option.active {
            color: #2196F3;
            font-weight: 500;
        }
        
        .quality-option.active::before {
            content: "✓";
            margin-right: 8px;
        }
        
        .progress-container {
            flex-grow: 1;
            height: 4px;
            background-color: rgba(255,255,255,0.2);
            margin: 0 10px;
            position: relative;
            cursor: pointer;
            border-radius: 2px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #2196F3;
            width: 0;
            position: relative;
            border-radius: 2px;
        }
        
        .progress-handle {
            position: absolute;
            right: -6px;
            top: 50%;
            width: 12px;
            height: 12px;
            background-color: #2196F3;
            border-radius: 50%;
            transform: translateY(-50%);
            display: none;
        }
        
        .progress-container:hover .progress-handle {
            display: block;
        }
        
        .timestamp {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
            margin: 0 5px;
            min-width: 100px;
            text-align: center;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.6);
            z-index: 30;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #2196F3;
            animation: spin 1s linear infinite;
        }
        
        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.8);
            z-index: 40;
            padding: 20px;
            text-align: center;
        }
        
        .error-icon {
            font-size: 48px;
            color: #f44336;
            margin-bottom: 16px;
        }
        
        .error-message {
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .retry-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        
        .retry-button:hover {
            background-color: #1976D2;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .buffering-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.6);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }
        
        /* Icons */
        .icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
    </style>
</head>
<body>
    <div class="player-wrapper">
        <div class="video-container">
            <video id="video" playsinline></video>
            
            <div class="controls-overlay">
                <div class="control-group">
                    <button class="control-button" id="play-pause">
                        <svg class="icon" id="play-icon" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg class="icon" id="pause-icon" viewBox="0 0 24 24" style="display: none;">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                        </svg>
                    </button>
                    
                    <div class="timestamp" id="timestamp">00:00 / 00:00</div>
                    
                    <div class="progress-container" id="progress-container">
                        <div class="progress-bar" id="progress-bar">
                            <div class="progress-handle"></div>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <button class="control-button" id="mute-toggle">
                        <svg class="icon" id="volume-icon" viewBox="0 0 24 24">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                        <svg class="icon" id="mute-icon" viewBox="0 0 24 24" style="display: none;">
                            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                        </svg>
                    </button>
                    
                    <button class="control-button" id="quality-toggle">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7.5 13h2v2H11V9H9.5v2.5h-2V9H6v6h1.5zm6.5 2h.75v1.5h1.5V15H17c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1h-3c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1zm.5-4.5h2v3h-2v-3z"/>
                        </svg>
                    </button>
                    
                    <button class="control-button" id="fullscreen-toggle">
                        <svg class="icon" id="fullscreen-icon" viewBox="0 0 24 24">
                            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                        </svg>
                        <svg class="icon" id="exit-fullscreen-icon" viewBox="0 0 24 24" style="display: none;">
                            <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="quality-menu" id="quality-menu">
                <div class="quality-option" data-quality="1080p">1080p</div>
                <div class="quality-option" data-quality="720p">720p</div>
                <div class="quality-option" data-quality="480p">480p</div>
                <div class="quality-option" data-quality="360p">360p</div>
            </div>
            
            <div class="loading-overlay" id="loading-overlay">
                <div class="spinner"></div>
            </div>
            
            <div class="error-overlay" id="error-overlay">
                <div class="error-icon">⚠️</div>
                <div class="error-message" id="error-message">An error occurred while loading the stream.</div>
                <button class="retry-button" id="retry-button">Try Again</button>
            </div>
            
            <div class="buffering-indicator" id="buffering-indicator">Buffering...</div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const video = document.getElementById('video');
            const playPauseBtn = document.getElementById('play-pause');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const muteToggle = document.getElementById('mute-toggle');
            const volumeIcon = document.getElementById('volume-icon');
            const muteIcon = document.getElementById('mute-icon');
            const fullscreenToggle = document.getElementById('fullscreen-toggle');
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            const exitFullscreenIcon = document.getElementById('exit-fullscreen-icon');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const timestamp = document.getElementById('timestamp');
            const qualityToggle = document.getElementById('quality-toggle');
            const qualityMenu = document.getElementById('quality-menu');
            const qualityOptions = document.querySelectorAll('.quality-option');
            const loadingOverlay = document.getElementById('loading-overlay');
            const errorOverlay = document.getElementById('error-overlay');
            const errorMessage = document.getElementById('error-message');
            const retryButton = document.getElementById('retry-button');
            const bufferingIndicator = document.getElementById('buffering-indicator');
            const videoContainer = document.querySelector('.video-container');
            
            // State
            let currentQuality = '720p'; // Default quality
            let hls = null;
            let isFullscreen = false;
            let inactivityTimer;
            const proxyBaseUrl = 'https://cstream-fly.onrender.com';
            
            // Initialize quality menu
            updateQualityMenu();
            
            // Function to load the stream
            function loadStream(quality) {
                // Show loading overlay
                loadingOverlay.style.display = 'flex';
                errorOverlay.style.display = 'none';
                
                // Destroy previous Hls instance if it exists
                if (hls) {
                    hls.destroy();
                }
                
                if (Hls.isSupported()) {
                    hls = new Hls({
                        debug: false,
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90,
                        maxBufferLength: 30,
                        maxMaxBufferLength: 60
                    });
                    
                    const playlistUrl = `${proxyBaseUrl}/proxy/playlist/${quality}`;
                    console.log("Loading playlist:", playlistUrl);
                    
                    hls.loadSource(playlistUrl);
                    hls.attachMedia(video);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        console.log('Manifest parsed, trying to play');
                        loadingOverlay.style.display = 'none';
                        
                        // Try to play
                        const playPromise = video.play();
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                // Playback started successfully
                                updatePlayPauseButton();
                            }).catch(err => {
                                console.error('Playback failed:', err);
                                // Auto-play was prevented, show play button
                                updatePlayPauseButton();
                            });
                        }
                    });
                    
                    // Handle errors
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS error:', data);
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.log('Network error, trying to recover...');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.log('Media error, trying to recover...');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    console.error('Fatal error, cannot recover');
                                    showError('Stream error. Please try again or select a different quality.');
                                    break;
                            }
                        }
                    });
                    
                    // Handle buffering
                    hls.on(Hls.Events.BUFFER_APPENDING, function() {
                        bufferingIndicator.style.display = 'block';
                    });
                    
                    hls.on(Hls.Events.FRAG_BUFFERED, function() {
                        bufferingIndicator.style.display = 'none';
                    });
                    
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    // For Safari
                    loadingOverlay.style.display = 'none';
                    video.src = `${proxyBaseUrl}/proxy/playlist/${quality}`;
                    video.addEventListener('loadedmetadata', function() {
                        video.play().catch(err => {
                            console.error('Playback failed:', err);
                            updatePlayPauseButton();
                        });
                    });
                } else {
                    showError('Your browser does not support HLS playback');
                    console.error('HLS is not supported in this browser');
                }
                
                // Update active quality option
                updateQualityMenu();
            }
            
            function updateQualityMenu() {
                qualityOptions.forEach(option => {
                    if (option.dataset.quality === currentQuality) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
            }
            
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                seconds = Math.floor(seconds % 60);
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            function updateProgressBar() {
                if (video.duration) {
                    const progress = (video.currentTime / video.duration) * 100;
                    progressBar.style.width = `${progress}%`;
                    
                    // Update timestamp
                    timestamp.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
                } else {
                    timestamp.textContent = "Live";
                }
            }
            
            function updatePlayPauseButton() {
                if (video.paused) {
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                } else {
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                }
            }
            
            function togglePlay() {
                if (video.paused) {
                    video.play().catch(err => {
                        console.error('Play failed:', err);
                        showError('Playback failed. Please try again.');
                    });
                } else {
                    video.pause();
                }
                updatePlayPauseButton();
            }
            
            function toggleMute() {
                video.muted = !video.muted;
                if (video.muted) {
                    volumeIcon.style.display = 'none';
                    muteIcon.style.display = 'block';
                } else {
                    volumeIcon.style.display = 'block';
                    muteIcon.style.display = 'none';
                }
            }
            
            function toggleFullscreen() {
                if (!isFullscreen) {
                    if (videoContainer.requestFullscreen) {
                        videoContainer.requestFullscreen();
                    } else if (videoContainer.webkitRequestFullscreen) {
                        videoContainer.webkitRequestFullscreen();
                    } else if (videoContainer.msRequestFullscreen) {
                        videoContainer.msRequestFullscreen();
                    }
                    isFullscreen = true;
                    fullscreenIcon.style.display = 'none';
                    exitFullscreenIcon.style.display = 'block';
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                    isFullscreen = false;
                    fullscreenIcon.style.display = 'block';
                    exitFullscreenIcon.style.display = 'none';
                }
            }
            
            function showError(message) {
                loadingOverlay.style.display = 'none';
                errorOverlay.style.display = 'flex';
                errorMessage.textContent = message;
            }
            
            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                document.body.style.cursor = 'default';
                inactivityTimer = setTimeout(() => {
                    if (!video.paused) {
                        document.body.style.cursor = 'none';
                    }
                }, 3000);
            }
            
            // Event listeners
            playPauseBtn.addEventListener('click', togglePlay);
            
            muteToggle.addEventListener('click', toggleMute);
            
            fullscreenToggle.addEventListener('click', toggleFullscreen);
            
            qualityToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                qualityMenu.classList.toggle('visible');
            });
            
            // Hide quality menu when clicking elsewhere
            document.addEventListener('click', function() {
                qualityMenu.classList.remove('visible');
            });
            
            qualityMenu.addEventListener('click', function(e) {
                e.stopPropagation();
                if (e.target.classList.contains('quality-option')) {
                    const newQuality = e.target.dataset.quality;
                    if (newQuality !== currentQuality) {
                        currentQuality = newQuality;
                        loadStream(currentQuality);
                    }
                    qualityMenu.classList.remove('visible');
                }
            });
            
            progressContainer.addEventListener('click', function(e) {
                const rect = progressContainer.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                video.currentTime = pos * video.duration;
            });
            
            video.addEventListener('timeupdate', updateProgressBar);
            
            video.addEventListener('play', updatePlayPauseButton);
            video.addEventListener('pause', updatePlayPauseButton);
            
            // Handle fullscreen change
            document.addEventListener('fullscreenchange', function() {
                isFullscreen = !!document.fullscreenElement;
                if (isFullscreen) {
                    fullscreenIcon.style.display = 'none';
                    exitFullscreenIcon.style.display = 'block';
                } else {
                    fullscreenIcon.style.display = 'block';
                    exitFullscreenIcon.style.display = 'none';
                }
            });
            
            // Auto-reload stream if it stalls
            video.addEventListener('stalled', function() {
                console.log('Stream stalled, reloading...');
                bufferingIndicator.style.display = 'block';
                setTimeout(() => {
                    if (hls) {
                        hls.startLoad();
                    }
                }, 2000);
            });
            
            // Handle waiting/buffering
            video.addEventListener('waiting', function() {
                bufferingIndicator.style.display = 'block';
            });
            
            video.addEventListener('playing', function() {
                bufferingIndicator.style.display = 'none';
            });
            
            // Retry button
            retryButton.addEventListener('click', function() {
                loadStream(currentQuality);
            });
            
            // Mouse movement tracking for cursor hiding
            document.addEventListener('mousemove', resetInactivityTimer);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                switch(e.key) {
                    case ' ':
                    case 'k':
                        togglePlay();
                        break;
                    case 'm':
                        toggleMute();
                        break;
                    case 'f':
                        toggleFullscreen();
                        break;
                    case 'ArrowRight':
                        video.currentTime += 10;
                        break;
                    case 'ArrowLeft':
                        video.currentTime -= 10;
                        break;
                    case '1':
                        currentQuality = '360p';
                        loadStream(currentQuality);
                        break;
                    case '2':
                        currentQuality = '480p';
                        loadStream(currentQuality);
                        break;
                    case '3':
                        currentQuality = '720p';
                        loadStream(currentQuality);
                        break;
                    case '4':
                        currentQuality = '1080p';
                        loadStream(currentQuality);
                        break;
                }
            });
            
            // Refresh stream periodically to avoid stalling on long viewing
            setInterval(() => {
                if (hls && !video.paused && video.readyState < 3) {
                    console.log('Refreshing stream...');
                    hls.startLoad();
                }
            }, 60000);  // Every minute
            
            // Initialize with default quality
            loadStream(currentQuality);
        });
    </script>
</body>
</html>
